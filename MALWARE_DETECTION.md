# Fuzzy Hash Malware Detection - Testing Guide

## ðŸ¦  Overview

The EDR now uses **fuzzy hashing (ssdeep)** to detect malware even when files are slightly modified. This allows detection of malware variants and polymorphic threats.

## How It Works

1. **Agent monitors file changes** in watched directories
2. **Computes both SHA256 and fuzzy hash** for each file
3. **Compares fuzzy hash** against known malware signatures
4. **If similarity â‰¥ 75%**, the file is automatically:
   - **Quarantined** to `/var/lib/edr/quarantine/`
   - **Alert sent** to the server with similarity score
   - **Deleted** from original location

## ðŸ§ª Test Malware Files Created

Three simulated malware samples are in `/home/rubberpirate/redr/test-malware/`:

1. **ransomware.sh** - Simulates ransomware file encryption
2. **keylogger.sh** - Simulates keystroke logging
3. **cryptominer.sh** - Simulates cryptocurrency mining

**These are SAFE test files** - they only print messages and don't cause any harm.

## ðŸ“Š Fuzzy Hash Signatures

The following fuzzy hashes have been added to the EDR server:

```
Cryptominer:  12:y83o8WD8H5nZc5FFvrlEUXyvBjgH0UompILGI8nbw:y4ox8+5FFvLiEUzaI8nbw
Keylogger:    6:OxkU5WBNWbQ9jxkU5WT8HAFAUY/pv5tAayoNXuLjB4F0NxfymMz25gV2GWKF/sxp:6MqgMT8H5pA7HLjBrHqn/FXt6ys8a
Ransomware:   12:hbQNW0v0RbQ88H57xG5cbYx64KQA6lSSVcUA+BoHYClJP69cErs8NDe2PAKV:qHm87BMx6fmlpe7ko4Cm9cT89FV
```

## ðŸ§ª Testing Steps

### Test 1: Exact Match Detection

1. **Copy malware to VM:**
   ```bash
   # On your host
   scp /home/rubberpirate/redr/test-malware/ransomware.sh user@vm:/tmp/
   ```

2. **On the VM**, the EDR agent should:
   - Detect the file creation
   - Compute fuzzy hash
   - Compare against signatures
   - Find 100% match
   - **Quarantine immediately**

3. **Check the UI:**
   - Go to **Alerts** tab
   - You should see: "ðŸ¦  MALWARE DETECTED"
   - Shows path, similarity score, and action taken

### Test 2: Modified File Detection (Fuzzy Match)

1. **Modify the malware slightly:**
   ```bash
   # On VM, edit the ransomware file
   nano /tmp/ransomware_modified.sh
   
   # Add/change a few lines:
   # - Add extra echo statements
   # - Change some text
   # - Add comments
   # Save it
   ```

2. **Copy to watched directory:**
   ```bash
   cp /tmp/ransomware_modified.sh /tmp/evil_script.sh
   ```

3. **The EDR should still detect it** if similarity â‰¥ 75%
   - Fuzzy hash will be different
   - But similar enough to trigger detection
   - Gets quarantined with similarity score shown

### Test 3: Check Quarantine

```bash
# On VM
sudo ls -la /var/lib/edr/quarantine/

# You should see the quarantined files
```

## ðŸ”§ Configuration

### View Current Signatures

```bash
curl http://172.16.0.2:8080/policy | jq '.malware_fuzzy_hashes'
```

### Add New Malware Signature

```bash
# 1. Get fuzzy hash of malware sample
ssdeep malware_sample.bin

# 2. Add to EDR (using the hash from ssdeep output)
curl -X POST http://172.16.0.2:8080/whitelist \
  -H 'Content-Type: application/json' \
  -d '{"type": "malware", "value": "FUZZY_HASH_HERE"}'
```

### Generate Signatures from Directory

```bash
cd /home/rubberpirate/redr
python3 generate_malware_sigs.py /path/to/malware/samples
```

## ðŸ“Š Detection Thresholds

- **100% similarity** = Exact match (always detected)
- **â‰¥ 90% similarity** = Strong variant match
- **â‰¥ 75% similarity** = Detection threshold (configurable)
- **< 75% similarity** = Not detected (file is different enough)

## ðŸŽ¯ What Gets Scanned

The agent monitors these directories (configurable via `EDR_WATCH_PATHS`):
- `/home` - User directories
- `/tmp` - Temporary files
- Any custom paths you specify

## âš ï¸ Important Notes

### Advantages of Fuzzy Hashing
- âœ… Detects malware variants
- âœ… Catches slightly modified malware
- âœ… Works against polymorphic threats
- âœ… No need for exact hash match

### Limitations
- âŒ May have false positives (similar legitimate files)
- âŒ Won't detect completely rewritten malware
- âŒ Small files may not produce reliable fuzzy hashes
- âŒ Computation is slower than SHA256

### Performance
- Fuzzy hashing adds ~50-100ms per file
- Only computed for files in watched directories
- Async processing doesn't block other operations

## ðŸš€ Deployment to VMs

1. **Update agent on VMs:**
   ```bash
   # Copy new agent binary to VMs
   scp /home/rubberpirate/redr/edr/agent/target/release/edr-agent user@vm:/path/to/redr/
   
   # On VM, restart agent
   sudo pkill edr-agent
   export EDR_SERVER_URL="http://172.16.0.2:8080"
   export EDR_AGENT_TOKEN="local-dev-token"
   export EDR_WATCH_PATHS="/home,/tmp"
   sudo -E ./edr-agent
   ```

2. **Signatures already loaded** on server (added via curl above)

3. **Test by copying malware** to `/tmp/` on VM

## ðŸ“ Logs & Monitoring

### Agent Logs
```bash
# Agent prints detection events
sudo journalctl -f | grep edr-agent
```

### Server Logs
```bash
# Server receives malware_detected events
tail -f /tmp/edr-telemetry.log | grep malware
```

### UI Alerts
- Real-time alerts in **Alerts** tab
- Shows similarity score
- Indicates quarantine action

## ðŸ”¬ Advanced: Creating Custom Malware Samples

```bash
# 1. Create a malicious script
cat > /tmp/test_malware.sh << 'EOF'
#!/bin/bash
# Your simulated malware code here
echo "Malicious behavior simulation"
EOF

# 2. Generate fuzzy hash
ssdeep /tmp/test_malware.sh

# 3. Add to EDR
curl -X POST http://172.16.0.2:8080/whitelist \
  -H 'Content-Type: application/json' \
  -d '{"type": "malware", "value": "HASH_FROM_STEP_2"}'

# 4. Test by copying to VM
```

## ðŸŽ“ Understanding Fuzzy Hashes

Fuzzy hash format: `blocksize:hash1:hash2`

Example: `12:y83o8WD8H5nZc5FFvrlEUXyvBjgH0UompILGI8nbw:y4ox8+5FFvLiEUzaI8nbw`
- `12` = Block size used
- First hash = Full context hash
- Second hash = Reduced context hash (for faster comparison)

The algorithm detects similarity even when:
- Lines are added/removed
- Text is changed slightly
- File is reformatted
- Code is obfuscated (to some degree)

## ðŸ” Security Best Practices

1. **Regularly update signatures** from threat intelligence feeds
2. **Test threshold** on your environment (75% may need tuning)
3. **Review quarantined files** for false positives
4. **Monitor similarity scores** in alerts
5. **Keep malware database** separate from production data
6. **Backup quarantine directory** for forensics

## ðŸ“ˆ Next Steps

- [ ] Integrate with VirusTotal API for cloud checking
- [ ] Add YARA rules support
- [ ] Implement signature auto-updates
- [ ] Machine learning classification
- [ ] Behavioral analysis integration
